#!/bin/bash

# Note Performer Downloader & Installer
# - finlayacourt

# Check for root
if [ `whoami` != 'root' ]
  then
    echo "You must be root to do this."
    exit
fi

# Download & install noteperformer
echo
echo 'Install Noteperformer [Y/n]'
read response
if [ $response != 'n' ]
  then
    echo
    echo 'Downloading...'
    curl https://www.noteperformer.com/DownloadNotePerformerTrial3.php -L > /tmp/noteperformer.pkg
    echo '...done'
    echo
    echo 'Removing old versions...'
    
    # Taken from Noteperformer Uninstaller
    LICENSE_FILE="/Library/Application Support/NotePerformer/.license"
    AVIDDIR="$HOME/Library/Application Support/Avid"
    SIBDDIR="$HOME/Library/Application Support/Sibelius Software"
    FINALEDIR="/Library/Application Support/MakeMusic/"
    DORICODIR="/Library/Application Support/Steinberg/"
    NP_DIR="/Library/Application Support/NotePerformer"
    
    # REMOVE ANY TEMPORARY .DS_Store FILES, OR FOLDERS CAN'T BE DELETED
    sudo find "$NP_DIR/" -name ".DS_Store" -depth -exec rm {} \; 2>/dev/null

    # PLUG-INS
    sudo rm -f -r "/Library/Audio/Plug-Ins/VST/NotePerformer.vst"
    sudo rm -f -r "/Library/Audio/Plug-Ins/Components/NotePerformer.component"

    # LICENSE FILE
    sudo rm -f "$LICENSE_FILE"

    # THIS UNINSTALLER
    sudo rm -f "$NP_DIR/Uninstall NotePerformer.command"

    # DOCUMENTATION
    sudo rm -f "$NP_DIR/Documentation"/*.pdf
    sudo rm -f "$NP_DIR/Documentation/EULA.txt"
    sudo rmdir  "$NP_DIR/Documentation" 2> /dev/null

    # SIBELIUS
    sudo rm -f "$NP_DIR/Sibelius/Playback Configurations/NotePerformer.xml"
    sudo rmdir  "$NP_DIR/Sibelius/Playback Configurations" 2> /dev/null

    sudo rm -f "$NP_DIR/Sibelius/Sounds/NotePerformer.xml"
    sudo rmdir  "$NP_DIR/Sibelius/Sounds" 2> /dev/null

    sudo rm -f "$NP_DIR/Sibelius/Plugins/"/*.plg
    sudo rmdir  "$NP_DIR/Sibelius/Plugins" 2> /dev/null

    sudo rmdir  "$NP_DIR/Sibelius" 2> /dev/null

    # FINALE
    sudo rm -f "$NP_DIR/Finale/Data/"/*.soundmap
    sudo rmdir "$NP_DIR/Finale/Data" 2> /dev/null

    sudo rm -f "$NP_DIR/Finale/FinaleScript/NotePerformer/"/*.xml
    sudo rmdir "$NP_DIR/Finale/FinaleScript/NotePerformer" 2> /dev/null
    sudo rmdir "$NP_DIR/Finale/FinaleScript" 2> /dev/null

    sudo rm -f "$NP_DIR/Finale/Human Playback/HP.preferences.xml"
    sudo rmdir "$NP_DIR/Finale/Human Playback" 2> /dev/null

    sudo rm -f "$NP_DIR/Finale/MIDI Device Annotation/NotePerformer.xml"
    sudo rmdir "$NP_DIR/Finale/MIDI Device Annotation" 2> /dev/null

    sudo rmdir "$NP_DIR/Finale" 2> /dev/null


    # DORICO
    sudo rm -f "$NP_DIR/Dorico"/*.doricolib
    sudo rm -f "$NP_DIR/Dorico"/*.xml
    sudo rm -f "$NP_DIR/Dorico"/*.pdf
    sudo rmdir  "$NP_DIR/Dorico" 2> /dev/null


    # NOTEPERFORMER FOLDER
    sudo rmdir  "$NP_DIR" 2> /dev/null

    # AVID SIBELIUS
    find "$AVIDDIR" -type d -maxdepth 1 -name *Sibelius* 2>/dev/null | while read SIB_FOLDERS
    do
      if [ -d "$SIB_FOLDERS" ]; then
          sudo rm -f "$SIB_FOLDERS/Playback Configurations/NotePerformer.xml"
          sudo rm -f "$SIB_FOLDERS/Sounds/NotePerformer.xml"	
          sudo rm -f "$SIB_FOLDERS/Plugins/NotePerformer/"/*.plg	
          sudo rm -f "$SIB_FOLDERS/Plugins/NotePerformer/.DS_Store"
          sudo rmdir "$SIB_FOLDERS/Plugins/NotePerformer" 2> /dev/null
      fi
    done

    # SIBELIUS 6
    find "$SIBDDIR" -type d -maxdepth 1 -name *Sibelius* 2>/dev/null | while read SIB_FOLDERS
    do
      if [ -d "$SIB_FOLDERS" ]; then
          sudo rm -f "$SIB_FOLDERS/Playback Configurations/NotePerformer.xml"
          sudo rm -f "$SIB_FOLDERS/Sounds/NotePerformer.xml"
          sudo rm -f "$SIB_FOLDERS/Plugins/NotePerformer/"/*.plg	
          sudo rm -f "$SIB_FOLDERS/Plugins/NotePerformer/.DS_Store"
          sudo rmdir "$SIB_FOLDERS/Plugins/NotePerformer" 2> /dev/null	
      fi
    done

    # FINALE
    find "$FINALEDIR" -type d -maxdepth 1 -name *Finale* | while read FIN_FOLDERS
    do
      if [ -d "$FIN_FOLDERS" ]; then
          sudo rm -f "$FIN_FOLDERS/Data/NotePerformer.soundmap"	
      fi
    done

    # DORICO
    find "$DORICODIR" -type d -maxdepth 1 -name *Dorico* 2>/dev/null | while read DOR_FOLDERS
    do
      if [ -d "$DOR_FOLDERS" ]; then

          sudo rm -f "$DOR_FOLDERS/DefaultLibraryAdditions/NotePerformer/NotePerformer Expression Maps.doricolib"	
          sudo rm -f "$DOR_FOLDERS/DefaultLibraryAdditions/NotePerformer/NotePerformer Percussion Maps.doricolib"
          sudo rm -f "$DOR_FOLDERS/DefaultLibraryAdditions/NotePerformer/.DS_Store"
          sudo rmdir "$DOR_FOLDERS/DefaultLibraryAdditions/NotePerformer" 2> /dev/null
          # (do not remove)
          #sudo rm -f "$DOR_FOLDERS/DefaultLibraryAdditions/.DS_Store"
          #sudo rmdir "$DOR_FOLDERS/DefaultLibraryAdditions" 2> /dev/null

          sudo rm -f "$DOR_FOLDERS/PluginPresetLibraries/NotePerformer/presets_for_instruments.xml"	
          sudo rm -f "$DOR_FOLDERS/PluginPresetLibraries/NotePerformer/presets.xml"
          sudo rm -f "$DOR_FOLDERS/PluginPresetLibraries/NotePerformer/.DS_Store"
          sudo rmdir "$DOR_FOLDERS/PluginPresetLibraries/NotePerformer" 2> /dev/null
          # (do not remove)
          #sudo rm -f "$DOR_FOLDERS/PluginPresetLibraries/.DS_Store"
          #sudo rmdir "$DOR_FOLDERS/PluginPresetLibraries" 2> /dev/null

          sudo rm -f "$DOR_FOLDERS/PlaybackTemplateGenerators/NotePerformer/playbacktemplategen.xml"
          sudo rm -f "$DOR_FOLDERS/PlaybackTemplateGenerators/NotePerformer/.DS_Store"
          sudo rmdir "$DOR_FOLDERS/PlaybackTemplateGenerators/NotePerformer" 2> /dev/null
          # (do not remove)
          #sudo rm -f "$DOR_FOLDERS/PlaybackTemplateGenerators/.DS_Store"
          #sudo rmdir "$DOR_FOLDERS/PlaybackTemplateGenerators" 2> /dev/null

      fi
    done
    echo "...done"
    echo
    echo 'Installing...'
    installer -package /tmp/noteperformer.pkg -target /
    rm /tmp/noteperformer.pkg
    echo '...done'
fi

# Reset Trial
echo
echo 'Reset Trial limit [Y/n]'
echo '(will fail if versions donâ€™t match, reinstall instead)'
read response
if [ $response != 'n' ]
  then
    echo
    echo 'Getting key...'
    filename=$(curl -sIL -X GET https://www.noteperformer.com/DownloadNotePerformerTrial3.php | grep 'filename' | sed -E 's/.*\[(.*)\].*/\1/g')
    date=$(echo $filename | sed -E 's/(.* .*) .*/\1/g')
    id=$(echo $filename |  sed -E 's/.* .* //g')
    echo $date
    echo $id
    echo 
    echo 'Patching...'
    rm -f "/Library/Application Support/NotePerformer/.license"
    echo "$date" >> "/Library/Application Support/NotePerformer/.license"
    echo ${id%??} >> "/Library/Application Support/NotePerformer/.license"
    echo '...done'
fi
exit
